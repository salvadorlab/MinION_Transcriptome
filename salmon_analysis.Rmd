---
title: "salmon_quan_diffExp"
author: "Rachel Xu"
date: "4/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "")
library(tximeta)
library(tximport)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
```

# list samples, read int metadata
```{r}
dir <- "/Users/rachel/Dropbox/5.Rachel-projects/Transcriptomics_PolyATail/quant_results"
salmon_dir <- "/Users/rachel/Dropbox/5.Rachel-projects/Transcriptomics_PolyATail/quant_results/salmon/"

# all samples
salmon_samples<- c(
"Q29_Copenhageni_Basecalled-June_11_2020_Repeat_Direct-RNA",
"Q29_Copenhageni_Basecalled_May_22_2020_Direct-RNA",
"Q36_Copenhageni_Basecalled_June_9_2020-Repeat_Direct-RNA",
"Q36_Copenhageni_Basecalled_May_31_2020_Direct-RNA")


all_meta <- read.csv(paste(dir, "all_flair.txt", sep="/"), sep="\t")
direct_rna_meta <- read.csv(paste(dir, "direct_flair.txt", sep="/"), sep="\t")

```


# read in salmon files
```{r}

# list all files
salmonfiles <- file.path(salmon_dir, "align_quant", "directRNA",paste0(salmon_samples,"_quant"), "quant.sf")
# check if all these files exist
all(file.exists(salmonfiles))
names(salmonfiles) <- salmon_samples
salmonfiles

# add file path to metadata
direct_rna_metadata <- cbind(direct_rna_meta, files=salmonfiles, stringsAsFactors=FALSE)
direct_rna_metadata$condition <- factor(direct_rna_metadata$condition)

## Import quantifications on the transcript level
txi <- tximport(salmonfiles, type="salmon", txOut=TRUE,
                countsFromAbundance="scaledTPM")
# txi
cts <- txi$counts
cts[1:3,1:3]
cts <- cts[rowSums(cts) > 0,]
# cts
```


### reference database
```{r}

library(GenomicFeatures)
gtf <- file.path(ref,"GCF_000007685.1_ASM768v1_genomic.gtf")
txdb.filename <- "GCF_000007685.1_ASM768v1_genomic.sqlite"
txdb <- makeTxDbFromGFF(gtf,format="gtf")
saveDb(txdb, txdb.filename)

txdb <- loadDb(txdb.filename)
txdf <- select(txdb, keys(txdb, "GENEID"), "TXNAME", "GENEID")
tab <- table(txdf$GENEID)
txdf$ntx <- tab[match(txdf$GENEID, names(tab))]

txdf


```


## DRIMSeq
```{r}

txdf <- txdf[match(rownames(cts),txdf$TXNAME),]
all(rownames(cts) == txdf$TXNAME)
rownames(cts) 
rownames(cts) == txdf$TXNAME
rownames(cts)
```



